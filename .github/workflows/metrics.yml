# ===================================================================================
# GitHub Metrics - Workflow utilisant notre instance Heroku
# ===================================================================================
# Utilise notre fork deploye sur Heroku pour eviter les bugs upstream
# Instance: https://metrics-globodai-a4c5f72d6399.herokuapp.com/
# ===================================================================================

name: GitHub Metrics

on:
  schedule:
    - cron: "0 6 * * *"
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  METRICS_HOST: https://metrics-globodai-a4c5f72d6399.herokuapp.com

jobs:
  generate-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Main Metrics
        run: |
          curl -sL "${{ env.METRICS_HOST }}/artik0din?base=header,activity,community,repositories,metadata&base.indepth=true&config.timezone=Asia/Dubai&config.animations=true&config.display=large&repositories.forks=true&token=${{ secrets.METRICS_TOKEN }}" -o metrics-main.svg

      - name: Generate Languages Metrics
        run: |
          curl -sL "${{ env.METRICS_HOST }}/artik0din?base=&plugin_languages=true&plugin_languages_indepth=true&plugin_languages_analysis_timeout=30&plugin_languages_categories=programming,markup&plugin_languages_colors=github&plugin_languages_details=bytes-size,percentage,lines&plugin_languages_limit=10&plugin_languages_sections=most-used&plugin_languages_ignored=html,css,scss,less&token=${{ secrets.METRICS_TOKEN }}" -o metrics-languages.svg

      - name: Generate Isocalendar
        run: |
          curl -sL "${{ env.METRICS_HOST }}/artik0din?base=&plugin_isocalendar=true&plugin_isocalendar_duration=full-year&token=${{ secrets.METRICS_TOKEN }}" -o metrics-isocalendar.svg

      - name: Generate Achievements
        run: |
          curl -sL "${{ env.METRICS_HOST }}/artik0din?base=&plugin_achievements=true&plugin_achievements_display=detailed&plugin_achievements_secrets=true&plugin_achievements_threshold=C&token=${{ secrets.METRICS_TOKEN }}" -o metrics-achievements.svg

      - name: Generate Habits
        run: |
          curl -sL "${{ env.METRICS_HOST }}/artik0din?base=&config.timezone=Asia/Dubai&plugin_habits=true&plugin_habits_charts=true&plugin_habits_charts_type=classic&plugin_habits_days=14&plugin_habits_facts=true&plugin_habits_from=100&token=${{ secrets.METRICS_TOKEN }}" -o metrics-habits.svg

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add *.svg
          git diff --staged --quiet || git commit -m "Update metrics-*.svg - [Skip GitHub Action]"
          git push
